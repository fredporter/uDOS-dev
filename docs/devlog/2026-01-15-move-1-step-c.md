# Step C: Real Notion Webhook Testing

**Date Started:** 2026-01-15  
**Status:** ðŸŸ¢ READY TO EXECUTE  
**Time Estimate:** 2-3 hours  
**Goal:** Connect app to real Notion workspace, validate end-to-end sync

---

## What We're Testing

âœ… **Already Complete (Steps A+B):**

- SQLite schema with 14 tables, 20 indexes
- DatabaseService with full CRUD + queue management
- NotionSyncService with webhook handler
- Svelte sync store with 5s polling
- SyncIndicator component with emoji badge + popover
- Dev Server webhook endpoint wired to database
- Type-safe HTTP client covering all endpoints
- App header monitoring integration

ðŸŽ¯ **Step C Goals:**

1. Set up real Notion API integration
2. Configure webhook subscription (using ngrok for local tunnel)
3. Test CRUD operations (create, update, delete pages)
4. Monitor queue in real-time via app UI
5. Verify sync processes end-to-end without errors
6. Detect and handle conflicts gracefully

---

## Prerequisites

### What You'll Need

1. **Notion Workspace** (free tier OK)
2. **Notion API Token** (create in workspace integrations)
3. **ngrok** installed (for localhost tunnel)
   ```bash
   brew install ngrok
   # or: ngrok --version (if already installed)
   ```
4. **4-5 Terminal Windows** (for multiple services)
5. **Time:** ~30-45 minutes setup, ~1-2 hours testing

### Quick Check

```bash
# Verify ngrok installed
which ngrok

# Verify all services can start
python -m wizard.dev_server --help
npm --version  # Should be 18+
```

---

## Execution Steps

### Phase 1: Notion API Setup (15 minutes)

**ðŸ“– See:** [docs/NOTION-SETUP.md](NOTION-SETUP.md)

**Quick Summary:**

1. Go to https://www.notion.so/profile/integrations â†’ "New integration"
2. Name it `uMarkdown Dev`, enable Read/Update/Insert/Delete
3. Copy the **Internal Integration Token** (starts with `secret_`)
4. Create webhook signing secret: `openssl rand -hex 32`
5. Create test database in Notion, share with integration
6. Update `app/.env.local` with token + secret

**Validation:**

```bash
# Check .env.local has values
grep VITE_NOTION app/.env.local
# Should show:
# VITE_NOTION_API_KEY=secret_...
# VITE_NOTION_WEBHOOK_SECRET=...
```

---

### Phase 2: Start Services (10 minutes)

**Terminal 1: Core**

```bash
cd /Users/fredbook/Code/uDOS
source .venv/bin/activate
./bin/start_udos.sh
# Wait for prompt, type: PING
# Should respond with pong
```

**Terminal 2: Wizard Production** (optional, for reference)

```bash
cd /Users/fredbook/Code/uDOS
source .venv/bin/activate
python -m wizard.server --port 8765
# Logs: "Wizard Server started on port 8765"
```

**Terminal 3: Dev Server** (main testing server)

```bash
cd /Users/fredbook/Code/uDOS
source .venv/bin/activate
export NOTION_API_KEY=secret_YOUR_TOKEN_HERE
export NOTION_WEBHOOK_SECRET=YOUR_SECRET_HERE
python -m wizard.dev_server --port 8766 --debug
# Logs: "[WIZ] Dev Server initialized with SQLite backend"
```

**Terminal 4: App (Tauri)**

```bash
cd /Users/fredbook/Code/uDOS/app
npm run tauri:dev
# Should open macOS window with Svelte app
# Click top-right area to see SyncIndicator
```

**Terminal 5: ngrok Tunnel** (for Notion webhooks)

```bash
ngrok http 8766
# Output:
#   Forwarding    https://abc123.ngrok.io -> http://localhost:8766
# Copy the HTTPS URL
```

**Validation:**

```bash
# Check all services responding
curl http://localhost:8766/health | jq
# Should return: {"status": "healthy"}
```

---

### Phase 3: Configure Webhook Subscription (10 minutes)

**Using the Notion API:**

```bash
# Set variables
NOTION_TOKEN="secret_YOUR_TOKEN_HERE"
WEBHOOK_URL="https://abc123.ngrok.io/api/v0/notion/webhook"  # From ngrok

# Get list of existing webhooks (may be empty)
curl -s https://api.notion.com/v1/webhooks \
  -H "Authorization: Bearer $NOTION_TOKEN" \
  -H "Notion-Version: 2022-06-28" | jq

# Create new webhook
curl -X POST https://api.notion.com/v1/webhooks \
  -H "Authorization: Bearer $NOTION_TOKEN" \
  -H "Content-Type: application/json" \
  -H "Notion-Version: 2022-06-28" \
  -d '{
    "events": ["page.created", "page.updated", "page.deleted"],
    "notification_url": "'$WEBHOOK_URL'",
    "options": {
      "flatten_properties_response": true
    }
  }' | jq

# Save the webhook ID for later
```

**Validation in Dev Server logs:**

```
# Terminal 3 should show:
[WIZ] Webhook configuration received
[WIZ] Listening for Notion events at /api/v0/notion/webhook
```

---

### Phase 4: Test CRUD Operations (30 minutes)

#### Test 4a: Create Page

1. **In Notion app:**

   - Open your `uMarkdown Test` database
   - Click "New" â†’ Add page
   - Title: "Test Document 1"
   - Type: "document"
   - Status: "draft"
   - Press Enter to save

2. **Watch ngrok terminal:**

   ```
   POST /api/v0/notion/webhook    201 Created
   ```

3. **Watch Dev Server logs (Terminal 3):**

   ```
   [WIZ] Webhook received: page.created
   [LOCAL] Validating signature... âœ“
   [SYNC] Queueing operation: insert document:page123
   [WIZ] Webhook processed successfully
   ```

4. **In App (Terminal 4):**

   - Click SyncIndicator badge (top-right)
   - Should show: "1 pending" â†’ "0 pending" (after ~2s)
   - Last sync time updates

5. **In SQLite:**
   ```bash
   sqlite3 memory/umarkdown.sqlite \
     "SELECT id, operation, status, created_at FROM notion_sync_queue ORDER BY created_at DESC LIMIT 3;"
   # Should show insert operation with "processed" status
   ```

**âœ… Create Test Passed If:**

- Webhook received in ngrok
- SyncIndicator shows pending count
- Queue empties after processing
- No errors in logs

---

#### Test 4b: Update Page

1. **In Notion:**

   - Edit "Test Document 1"
   - Change title to "Test Document 1 - Updated"
   - Save

2. **Watch same monitoring as above**
   - ngrok: POST /api/v0/notion/webhook
   - Dev Server: "page.updated" queued
   - App: SyncIndicator updates
   - SQLite: "update" operation shows "processed"

**âœ… Update Test Passed If:**

- Same as Create test, operation type is "update"

---

#### Test 4c: Delete Page

1. **In Notion:**

   - Right-click "Test Document 1 - Updated"
   - Select "Delete"
   - Confirm

2. **Watch same monitoring**
   - Operation: "delete"

**âœ… Delete Test Passed If:**

- Same as Create test, operation type is "delete"

---

#### Test 4d: Multiple Operations

Repeat 4a-4c two more times:

1. Create "Test Document 2"
2. Update "Test Document 2"
3. Delete "Test Document 2"

Watch SyncIndicator:

- Should show "3 pending" initially
- Should count down to "0" over ~6 seconds
- Popover shows all 3 operations

**âœ… Bulk Test Passed If:**

- All operations processed
- No errors in logs
- Queue empties completely

---

#### Test 4e: Conflict Detection

1. **Create page in Notion:**

   - Title: "Conflict Test"
   - Status: "draft"
   - Wait for sync to process

2. **Edit the same document:**

   - In Notion: change Status to "published" (DON'T save yet)
   - In SQLite, simultaneously: update the page locally

   ```bash
   # In another terminal:
   sqlite3 memory/umarkdown.sqlite \
     "UPDATE notion_maps SET local_modified = datetime('now')
      WHERE notion_id = 'page_id_here';"
   ```

3. **In Notion:** save your change

4. **Watch Dev Server logs:**

   ```
   [SYNC] Conflict detected: both local and remote modified
   [LOCAL] Recording conflict in database
   ```

5. **In App SyncIndicator:**
   - Popover should show "1 conflict"
   - Click to view conflict details

**âœ… Conflict Test Passed If:**

- Conflict recorded in database
- UI shows conflict count
- No operations lost

---

### Phase 5: Verify Database State (10 minutes)

```bash
# Terminal 5: Query SQLite directly

# 1. Check all operations were queued
sqlite3 memory/umarkdown.sqlite << 'EOF'
SELECT COUNT(*), operation, status
FROM notion_sync_queue
GROUP BY operation, status
ORDER BY operation;
EOF

# Expected output:
# 3 | insert | processed
# 3 | update | processed
# 3 | delete | processed

# 2. Check mappings were created
sqlite3 memory/umarkdown.sqlite << 'EOF'
SELECT COUNT(*) as total_mappings
FROM notion_maps;
EOF

# 3. Check no orphaned conflicts
sqlite3 memory/umarkdown.sqlite << 'EOF'
SELECT COUNT(*) as total_conflicts
FROM sync_conflicts
WHERE resolved = 0;
EOF

# 4. View sync log (audit trail)
sqlite3 memory/umarkdown.sqlite << 'EOF'
SELECT timestamp, operation, status, message
FROM sync_log
ORDER BY timestamp DESC
LIMIT 10;
EOF
```

---

### Phase 6: Run Local Webhook Tests (Optional)

Instead of creating real Notion documents, test with simulated webhooks:

```bash
# Terminal 6: Simulate webhook events
cd /Users/fredbook/Code/uDOS

# Test 1: Create event
python -m wizard.services.dev.webhook_test_client \
  --test create \
  --url http://localhost:8766/api/v0/notion/webhook

# Test 2: Bulk operations
python -m wizard.services.dev.webhook_test_client \
  --test bulk \
  --count 10 \
  --url http://localhost:8766/api/v0/notion/webhook

# Test 3: With signature validation
python -m wizard.services.dev.webhook_test_client \
  --test bulk \
  --secret "YOUR_WEBHOOK_SECRET_HERE" \
  --url http://localhost:8766/api/v0/notion/webhook
```

**Watch SyncIndicator update in real-time as events arrive!**

---

## Success Checklist

### Before Testing

- [ ] Notion API token generated and saved
- [ ] Webhook secret generated
- [ ] `.env.local` configured with credentials
- [ ] ngrok installed and working
- [ ] All 4-5 services start without errors

### During Testing

- [ ] Create page in Notion, received in Dev Server âœ…
- [ ] SyncIndicator shows pending count âœ…
- [ ] Queue processes automatically (5s) âœ…
- [ ] SQLite shows "processed" status âœ…
- [ ] Update page, webhook received âœ…
- [ ] Delete page, webhook received âœ…
- [ ] 3 operations total process correctly âœ…

### Final Validation

- [ ] No errors in any terminal logs
- [ ] Database has 9 operations (3 create, 3 update, 3 delete)
- [ ] All operations show "processed" status
- [ ] Conflict detection works
- [ ] ngrok shows 9+ successful POST requests

---

## Troubleshooting

### "Webhook not received"

**Check:**

1. ngrok tunnel still active: `ngrok terminals should show requests`
2. Firewall allows 8766: `curl http://localhost:8766/health`
3. Notion integration shared: Database â†’ Share â†’ Check integration listed
4. Webhook URL correct: Notion API â†’ Webhooks â†’ Check notification_url

**Fix:**

```bash
# Restart ngrok
ngrok http 8766

# Update webhook URL in Notion
# (May need to delete old one and create new)
```

### "Signature validation failed"

**Dev Server logs show:**

```
[WIZ] Signature validation failed
```

**Fix:**

1. Verify `NOTION_WEBHOOK_SECRET` matches what you created
2. Temporarily disable for testing:
   ```python
   # In notion_sync_service.py line 50:
   # return True  # Skip validation
   ```

### "Database not found"

**Dev Server logs show:**

```
[LOCAL] database not found: memory/umarkdown.sqlite
```

**Fix:**

```bash
# Database auto-creates, but check directory exists
ls -la memory/
mkdir -p memory

# Force schema recreation
rm memory/umarkdown.sqlite
python -m wizard.dev_server --port 8766 --reset
```

### "SyncIndicator not updating"

**Check:**

1. App console: F12 â†’ Console tab, look for fetch errors
2. Dev Server logs: Check `/api/v0/notion/sync/status` endpoint
3. Manual refresh: Click "Refresh" button in popover

**Fix:**

```bash
# Test endpoint directly
curl http://localhost:8766/api/v0/notion/sync/status | jq

# Should return:
# {"status": "healthy", "pendingCount": 0, ...}
```

---

## Next Steps (After Step C)

### Immediate (This Week)

- [ ] Commit changes with proper message
- [ ] Review Step C results with team
- [ ] Document any issues found

### Short Term (Next Week)

- [ ] **Step D:** Unit tests (database_service, notion_sync_service)
- [ ] **Step E:** Error handling refinement
- [ ] **Step F:** Bidirectional sync (Phase 2 planning)

### Medium Term (Next 2-3 Weeks)

- **Move 2:** TS Markdown Runtime (Phase 0: parse, state, form)
- **Move 3:** Task Scheduler + Binder Compilation

---

## Reference Links

- **Notion API:** https://developers.notion.com/reference
- **Webhook Docs:** https://developers.notion.com/reference/create-a-webhook
- **ngrok:** https://ngrok.com/docs
- **SQLite:** https://www.sqlite.org/docs.html
- **Dev Server Endpoints:** http://localhost:8766/docs (when running)

---

**Ready to begin? Start with Phase 1 above!**

_Last Updated: 2026-01-15 by GitHub Copilot_
