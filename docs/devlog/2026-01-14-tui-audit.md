# TUI Audit & Consolidation Plan

**Date:** 2026-01-14  
**Sprint:** Alpha v1.0.2.0  
**Status:** Analysis Complete, Implementation Planned

---

## ğŸ¯ Objectives Completed

1. âœ… Identified hardcoded terminal dimensions across TUI codebase
2. âœ… Found duplicate implementations (box drawing, progress bars)
3. âœ… Enhanced VS Code workspace settings with quality tracking
4. âœ… Created actionable consolidation plan
5. âœ… Documented archival strategy

---

## ğŸ“Š Key Findings

### Duplicate Implementations

| Component | Files | Recommendation |
|-----------|-------|----------------|
| **Box Drawing** | 3 implementations (panel_templates, graphics, block_graphics) | Consolidate to `panel_templates.py` |
| **Progress Bars** | 4 implementations | Consolidate to `progress_indicators.py` |
| **Terminal Detection** | Multiple ad-hoc | Create `viewport_utils.py` |

**Impact:** 19 files using box drawing, all need import updates

### Hardcoded Dimensions

| Priority | Files | Issue | Solution |
|----------|-------|-------|----------|
| ğŸ”´ HIGH | 5 files | Fixed viewport heights (15, 24) | Dynamic calculation |
| ğŸŸ¡ MEDIUM | 10 files | Fixed widths (60, 80, 120) | Terminal detection |
| âœ… LOW | 5 files | Fallback values only | Already OK |

**Critical:** `file_browser.py:392` has `viewport_height = 15` that breaks on small terminals

---

## ğŸ› ï¸ Changes Made Today

### 1. VS Code Settings Enhanced

**File:** `.vscode/settings.json`

Added:
- Python type checking: `"python.analysis.typeCheckingMode": "basic"`
- Duplicate import detection: `"reportDuplicateImport": "error"`
- New TODO tag: `ARCHIVE` for marking old code
- Fixed syntax errors (duplicate commas, typos)

### 2. Documentation Created

| Document | Purpose |
|----------|---------|
| `TUI-CONSOLIDATION-TODO.md` | Master plan for code consolidation |
| `HARDCODED-VALUES-AUDIT.md` | Detailed audit of all hardcoded values |
| `docs/devlog/2026-01-14-tui-audit.md` | This document |

---

## ğŸ“‹ Implementation Plan

### Phase 1: Box Drawing Consolidation (2-3 hours)

**Priority:** HIGH  
**Files Affected:** 19

1. Create `core/ui/components/box_drawing.py`:
   ```python
   # Consolidated box drawing module
   from core.ui.panel_templates import BoxStyle, BoxChars, BOX_CHARS
   
   __all__ = ['BoxStyle', 'BoxChars', 'BOX_CHARS', 'get_box_chars']
   
   def get_box_chars(style: BoxStyle = BoxStyle.SINGLE) -> BoxChars:
       """Get box drawing characters for specified style."""
       return BOX_CHARS[style]
   ```

2. Update all 19 files to import from new module

3. Archive duplicate implementations:
   - `core/output/graphics.py` â†’ Extract BoxChars class to `.archive/2026-01-14/graphics_box_chars.py`
   - Add deprecation warnings to old locations

### Phase 2: Progress Bars (2 hours)

**Priority:** HIGH  
**Files Affected:** 4+

1. Keep `core/ui/progress_indicators.py` as primary
2. Remove duplicates from:
   - `core/output/graphics.py`
   - `core/services/output_pacer.py`
3. Update `progress_manager.py` to delegate to indicators

### Phase 3: Viewport Detection (3-4 hours)

**Priority:** MEDIUM  
**Files Affected:** 15+

1. Create `core/utils/viewport_utils.py`:
   ```python
   import shutil
   from typing import Tuple
   
   def get_terminal_size() -> Tuple[int, int]:
       """Get current terminal size with fallback."""
       try:
           size = shutil.get_terminal_size()
           return (min(size.columns, 180), size.lines)
       except:
           return (80, 24)  # Safe fallback
   
   def calculate_viewport_height(total_height: int, header: int = 2, footer: int = 2) -> int:
       """Calculate usable viewport height."""
       return max(10, total_height - header - footer)
   ```

2. Update hardcoded values in priority order:
   - ğŸ”´ HIGH: file_browser.py, visual_selector.py, json_viewer.py
   - ğŸŸ¡ MEDIUM: command_predictor.py, map_renderer.py, pattern_editor.py
   - âœ… LOW: Keep fallbacks in layout_manager.py

---

## ğŸ§ª Testing Strategy

Before each phase:

1. **Unit Tests:**
   ```bash
   pytest core/tests/ui/ -v
   pytest core/tests/output/ -v
   ```

2. **Integration Tests:**
   ```bash
   # In TUI
   SHAKEDOWN
   ```

3. **Visual Tests:**
   - Test in 80-column terminal
   - Test in 120-column terminal
   - Test in 180+ column terminal (wide screen)
   - Verify no wrapping or clipping

4. **Regression Tests:**
   - All existing commands work
   - No visual glitches
   - Performance unchanged

---

## ğŸ“¦ Archive Strategy

All duplicate/deprecated code goes to `.archive/YYYY-MM-DD/`:

```
core/
â”œâ”€â”€ ui/.archive/2026-01-14/
â”‚   â”œâ”€â”€ graphics_box_chars.py      # Extracted from graphics.py
â”‚   â””â”€â”€ README.md                  # Why archived
â”œâ”€â”€ output/.archive/2026-01-14/
â”‚   â”œâ”€â”€ graphics_progress.py       # Extracted progress bars
â”‚   â””â”€â”€ README.md
â””â”€â”€ services/.archive/2026-01-14/
    â”œâ”€â”€ output_pacer_progress.py   # Extracted progress method
    â””â”€â”€ README.md
```

Each archive includes:
- Timestamp: YYYY-MM-DD
- Reason for archival
- Migration path (what replaced it)
- Original file location

---

## ğŸ·ï¸ Code Tagging Convention

Use these tags for tracking:

```python
# HARDCODED: Replace with terminal detection
# See: HARDCODED-VALUES-AUDIT.md
viewport_height = 15

# DUPLICATE: Use core.ui.panel_templates.BoxChars
# Archive: .archive/2026-01-14/graphics_box_chars.py
class BoxChars:
    ...

# MODULARIZE: Extract to core.ui.components.progress_bars
# Benefits: Reuse across handlers
def show_progress():
    ...

# DEPRECATED: Use core.utils.viewport_utils.get_terminal_size()
# ARCHIVE: .archive/2026-01-14/
def old_terminal_size():
    return (80, 24)
```

VS Code TODO Tree will highlight these automatically.

---

## ğŸ“ˆ Success Metrics

| Metric | Before | Target | Verification |
|--------|--------|--------|--------------|
| Duplicate implementations | 7+ | 0 | Code audit |
| Hardcoded dimensions | 20+ | <5 | Grep search |
| Box drawing imports | 19 files | Consolidated | Import analysis |
| Progress bar code | 4 locations | 1 primary | Code review |
| Archive size | 0 files | ~10 files | Directory check |

---

## ğŸš¦ Risk Assessment

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Breaking imports | HIGH | MEDIUM | Incremental changes, thorough testing |
| Viewport detection fails | MEDIUM | LOW | Keep fallback values |
| Performance regression | LOW | LOW | Benchmark before/after |
| Visual glitches | MEDIUM | MEDIUM | Visual testing on multiple terminals |

---

## ğŸ“… Timeline

| Phase | Duration | Start | Complete |
|-------|----------|-------|----------|
| **Phase 1: Box Drawing** | 2-3 hours | TBD | TBD |
| **Phase 2: Progress Bars** | 2 hours | TBD | TBD |
| **Phase 3: Viewport Detection** | 3-4 hours | TBD | TBD |
| **Testing & QA** | 2 hours | TBD | TBD |
| **Documentation** | 1 hour | TBD | TBD |
| **Total** | 10-12 hours | - | - |

**Recommended:** Spread over 3-4 days with testing between phases

---

## ğŸ”— Related Documents

- [TUI-CONSOLIDATION-TODO.md](../../TUI-CONSOLIDATION-TODO.md) - Detailed task breakdown
- [HARDCODED-VALUES-AUDIT.md](../../HARDCODED-VALUES-AUDIT.md) - Complete audit results
- [AGENTS.md](../../AGENTS.md) - Agent rules and workflows
- [docs/roadmap.md](../roadmap.md) - Current sprint goals

---

## ğŸ¯ Next Actions

1. **Immediate (Today):**
   - [x] Complete audit
   - [x] Document findings
   - [x] Update VS Code settings
   - [ ] Review with team

2. **This Week:**
   - [ ] Create consolidation branch: `feature/tui-consolidation`
   - [ ] Implement Phase 1 (Box Drawing)
   - [ ] Run tests, validate changes
   - [ ] Merge if successful

3. **Next Week:**
   - [ ] Implement Phase 2 (Progress Bars)
   - [ ] Implement Phase 3 (Viewport Detection)
   - [ ] Final testing and documentation
   - [ ] Merge to main

---

## ğŸ’¡ Lessons Learned

1. **Duplication creeps in:** Without central modules, similar functionality gets reimplemented
2. **Hardcoded values everywhere:** Easy to hardcode during rapid development, hard to fix later
3. **TODO tracking helps:** VS Code TODO Tree makes technical debt visible
4. **Archives preserve history:** Don't delete old code, archive it with context
5. **Incremental is safer:** Small, tested changes beat big rewrites

---

**Status:** Ready for Phase 1 implementation  
**Confidence:** High (clear plan, low risk, incremental approach)  
**Owner:** Agent + Human review

---

*Last Updated: 2026-01-14 14:30*  
*Version: Alpha v1.0.2.0*  
*Sprint: Workspace Architecture + TinyCore Distribution*
