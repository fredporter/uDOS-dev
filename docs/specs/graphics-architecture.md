# Graphics Architecture: Three-Tier Rendering System

**Version:** 1.0.0 (Draft)  
**Date:** 2026-01-14  
**Status:** Architecture Review + Implementation Plan  
**Owner:** uDOS Graphics / App / Core teams

---

## ğŸ“ Overview

uDOS uses a **three-tier graphics architecture** where markdown-native formats are the single source of truth, with fallback/escalation paths based on context:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SOURCE: Markdown Native (Flowcharts/Diagrams/Marp) â”‚
â”‚ (Version-controlled, human-readable, portable)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                         â”‚             â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”     â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ TUI       â”‚         â”‚ Tauri App â”‚     â”‚ Realm  â”‚
   â”‚ (ASCII)   â”‚         â”‚ (SVG)     â”‚     â”‚ (etc)  â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜     â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                        â”‚             â”‚
        â”‚ Fallback:              â”‚ Primary:    â”‚
        â”‚ Teletext Blocks        â”‚ SVG Proc.   â”‚
        â”‚ (ASCII-mapped)         â”‚ (Renderer)  â”‚
        â”‚                        â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Graphics Service  â”‚
          â”‚ (Port 5555)       â”‚
          â”‚ Node.js Renderer  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Three Tiers Explained

### Tier 1: SOURCE (Markdown Native)

**Purpose:** Single source of truth, portable, version-controlled  
**Formats:**

- **Flowchart.js syntax** - Flowcharts, decision trees, sequences
- **Mermaid diagrams** - Flow, state, class, sequence, ER, Gantt (via Marp)
- **Marp presentations** - Full slides with HTML5 export
- **Knowledge guides** - Embedded diagrams in markdown

**Characteristics:**

- Plain text, git-friendly
- Human-readable and editable
- Can be generated by uPY scripts (DIAGRAM GENERATE)
- Maps directly to both ASCII and SVG

**Storage:**

```
knowledge/
â”œâ”€â”€ food/recipe.md              # Inline Mermaid diagram
â”œâ”€â”€ shelter/blueprint-guide.md  # Flowchart diagrams
â””â”€â”€ diagrams/
    â”œâ”€â”€ firebow.txt            # ASCII result
    â””â”€â”€ water-cycle.svg        # SVG result
```

---

### Tier 2: FALLBACK (ASCII-Teletext for TUI)

**Purpose:** TUI-friendly rendering without external services  
**Format:** ASCII characters + Unicode teletext blocks  
**Mapped from:** Markdown flowchart/diagram source

**Implementation:**

- Teletext blocks map to flowchart shapes
- Box drawing characters (â”œâ”€â”¬â”¤) form connections
- Block characters (â–€â–„â–Œâ–â–ˆ) create filled areas
- Color mapping (if terminal supports 16 colors)

**Examples:**

```
Flowchart source:
  flowchart TD
    A[Start] --> B{Decision}
    B -->|Yes| C[Action]

Teletext ASCII fallback:
  â•”â•â•â•â•â•â•â•â•â•—
  â•‘ Start  â•‘
  â•šâ•â•â•â•¤â•â•â•â•â•
      â”‚
    â—‡â”€â”´â”€â—‡
    â”‚     â”‚
    â”‚Yes  â”‚
    â”‚     â”‚
  â•”â•â–¼â•â•—  ...
  â•‘Actâ•‘
  â•šâ•â•â•â•
```

**Critical Requirement:**

- ASCII version **MUST be semantically equivalent** to diagram
- Colors encode meaning (red=error, green=success)
- Blocks must align to terminal character grid

---

### Tier 3: ESCALATION (SVG for App/Desktop/Web)

**Purpose:** High-fidelity rendering for GUI contexts  
**Format:** SVG markup (rendered by browser/Tauri)  
**Source:** Same markdown source, processed via Graphics Service

**Pipeline:**

1. Markdown flowchart/diagram â†’ Graphics Service
2. Service renders to SVG using appropriate theme
3. SVG returned to Tauri app
4. App renders with full styling (shadows, gradients, animations)

**Themes Available:**

- `technical` - Minimal, black/white
- `kinetic` - Colorful, rounded corners
- `classic` - Traditional box drawing
- `handwritten` - Casual/sketchy style

---

## ğŸ”— Integration Points

### Core (TUI)

**Services:**

- [core/services/graphics_service.py](../../core/services/graphics_service.py) - Python client to Graphics Service
- [core/services/diagram_generator.py](../../core/services/diagram_generator.py) - Auto-generate from descriptions
- [core/ui/block_graphics.py](../../core/ui/block_graphics.py) - ASCII-teletext rendering

**Commands:**

- `DIAGRAM LIST` - Browse knowledge diagrams
- `DIAGRAM SHOW <name>` - Display in TUI (ASCII)
- `DIAGRAM RENDER <name> <width>` - Fit to viewport
- `DIAGRAM GENERATE <file>` - Extract/create diagrams

**Handler:** [core/commands/diagram_handler.py](../../core/commands/diagram_handler.py)

**Rendering:**

```python
# TUI rendering path
from core.services.graphics_service import get_graphics_service

service = get_graphics_service()
ascii_output = service.render_ascii(
    template="flowchart/decision-tree",
    data={"labels": ["A", "B", "C"]},
    options={"width": terminal_width - 4}
)
```

---

### App (Tauri + Svelte)

**Components:**

- [app-beta/src/lib/components/DiagramRenderer.svelte](../../app-beta/src/lib/components/DiagramRenderer.svelte) - SVG renderer
- [app-beta/src/lib/components/MarpPresentation.svelte](../../app-beta/src/lib/components/MarpPresentation.svelte) - Marp integration

**SVG Processing:**

```svelte
<!-- Tauri app rendering path -->
<script>
  import DiagramRenderer from './DiagramRenderer.svelte';
  import MarpPresentation from './MarpPresentation.svelte';

  export let markdown_source: string;
  export let diagram_type: string; // 'flowchart' | 'mermaid' | 'marp'
</script>

{#if diagram_type === 'marp'}
  <MarpPresentation source={markdown_source} />
{:else}
  <DiagramRenderer source={markdown_source} theme="kinetic" />
{/if}
```

**Key Feature:** SVG processor is the **central piece** - handles all visual formatting

---

### API (Graphics Service Bridge)

**Service:** `core/services/graphics_service.py`  
**Endpoints:**

```
POST /render/ascii
  Input: template, data, options
  Output: ASCII text

POST /render/teletext
  Input: content, palette, options
  Output: Unicode teletext + colors

POST /render/svg
  Input: description, style, options
  Output: SVG markup

POST /render/sequence
  Input: js-sequence syntax
  Output: SVG markup

POST /render/flow
  Input: flowchart.js syntax
  Output: SVG markup

GET /templates/{format}
  Output: List of available templates

GET /catalog
  Output: Full diagram catalog (formats/templates/styles)
```

**Modes:**

1. **Connected:** Calls Node.js service on port 5555
2. **Fallback:** Renders ASCII locally if service unavailable
3. **Offline:** Uses cached templates from `core/data/diagrams/`

---

## ğŸŒ€ Format Mapping Strategy

### From Markdown Source to Outputs

```
Markdown Source
â”‚
â”œâ”€> Mermaid/Flowchart.js
â”‚   â”œâ”€> SVG (via Graphics Service) â†’ Tauri App
â”‚   â””â”€> ASCII (teletext mapped) â†’ TUI
â”‚
â”œâ”€> Marp Presentation
â”‚   â”œâ”€> HTML5 (via Marp CLI) â†’ Export/Web
â”‚   â”œâ”€> SVG (slides as images) â†’ App
â”‚   â””â”€> Text outline â†’ TUI (degraded)
â”‚
â””â”€> Knowledge Guide (inline)
    â”œâ”€> Extract diagrams
    â”œâ”€> Render each to ASCII â†’ TUI
    â””â”€> Render each to SVG â†’ App
```

### Alignment Requirement

**TUI ASCII MUST map semantically to SVG:**

| Concept            | SVG                     | Teletext ASCII            |
| ------------------ | ----------------------- | ------------------------- |
| Box                | `<rect>`                | `â•”â•â•â•â•—`                   |
| Arrow              | `<path>` with arrowhead | `â”€â”€â†’` or `â”€â”¬â”€`            |
| Diamond (decision) | `<polygon>`             | `â—Š` or `â•± â•²`              |
| Circle             | `<circle>`              | `â—` or `()`               |
| Text               | `<text>`                | Centered in box           |
| Color/meaning      | Fill/stroke             | Box style or bright color |

**Example Alignment:**

Source flowchart:

```
flowchart TD
    A[Start] -->|Yes| B[Action]
    A -->|No| C[Skip]
```

SVG Output (Tauri):

- Rounded rectangle box for A
- Arrows with decision labels
- Green arrow for Yes path
- Red arrow for No path

Teletext ASCII Output (TUI):

```
â•”â•â•â•â•â•â•â•â•â•â•—
â•‘  Start  â•‘
â•šâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â•
     â”‚
   Yesâ”‚No
     â”‚ â”‚
   â”Œâ”€â”˜ â””â”€â”
 â•”â•â–¼â•â•— â•”â•â–¼â•â•—
 â•‘Actâ•‘ â•‘Skpâ•‘
 â•šâ•â•â•â• â•šâ•â•â•â•
```

**Key:** Colors in TUI (if supported):

- Green: Success/Yes paths
- Red: Failure/No paths
- Blue: Process boxes
- Yellow: Decisions

---

## ğŸ“‹ Implementation Checklist

### Phase 1: Consolidate Graphics Service (2 weeks)

- [ ] Verify Graphics Service (Node.js) is properly documented
- [ ] Test all 5 rendering formats (ascii, teletext, svg, sequence, flow)
- [ ] Create comprehensive Graphics Service API docs
- [ ] Document port 5555 registration in [extensions/PORT-REGISTRY.md](../../extensions/PORT-REGISTRY.md)
- [ ] Test offline fallback (service unavailable)

### Phase 2: Standardize Teletext Blocks (1 week)

- [ ] Create [docs/specs/teletext-mapping.md](../specs/teletext-mapping.md)
- [ ] Document BOX_TO_BLOCK mapping in [core/ui/block_graphics.py](../../core/ui/block_graphics.py)
- [ ] Add color/attribute mapping (bold, dim, color)
- [ ] Test all combinations (box styles + colors)
- [ ] Create test suite for ASCII equivalency

### Phase 3: Markdown â†’ Output Pipeline (2 weeks)

- [ ] Document markdown diagram extraction in guides
- [ ] Create DIAGRAM GENERATE command (uses GraphicsService)
- [ ] Implement automatic ASCII version creation
- [ ] Add markdown source caching (for offline access)
- [ ] Test with 10+ diagrams from knowledge base

### Phase 4: App SVG Integration (2 weeks)

- [ ] Build DiagramRenderer.svelte component
- [ ] Integrate with markdown parser
- [ ] Test SVG embedding in format rendering
- [ ] Add theme switching
- [ ] Document SVG processor in app-beta/docs/

### Phase 5: TUI-App Consistency (1 week)

- [ ] Cross-test: Same diagram shows consistently across TUI/App
- [ ] Verify semantic equivalency (ASCII â‰ˆ SVG)
- [ ] Edge cases: Very wide/narrow terminals
- [ ] Performance: Large diagrams shouldn't lag
- [ ] Documentation: User guide for diagram formats

---

## ğŸ”Œ Port Registry Entry

```
# Graphics Renderer Service
Port: 5555
Service: graphics-renderer (Node.js)
Protocol: HTTP
Endpoints:
  POST /render/ascii - ASCII template rendering
  POST /render/teletext - Unicode teletext rendering
  POST /render/svg - SVG diagram rendering
  POST /render/sequence - Sequence diagram (js-sequence)
  POST /render/flow - Flowchart (flowchart.js)
  GET /templates/{format} - List templates
  GET /catalog - Full catalog
Dependencies:
  - mermaid.js
  - flowchart.js
  - js-sequence-diagrams
  - svg generation libraries
Fallback: Local ASCII rendering (core/services/diagram_generator.py)
Realm: Local device (no internet), private mesh only
```

---

## ğŸ“š Format Examples

### Flowchart Markdown Source

````markdown
# Decision Tree

```flowchart
flowchart TD
    Start([Start]) --> Q{Valid?}
    Q -->|Yes| Action[Process]
    Q -->|No| Error[Error]
    Action --> End([End])
    Error --> End
```
````

In TUI, renders as:

```
â•”â•â•â•â•â•â•â•â•â•â•—
â•‘  Start  â•‘
â•šâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â•
     â”‚
   â—Šâ”€â—‡â”€â—Š
   â”‚   â”‚
Yesâ”‚   â”‚No
   â”‚   â”‚
 â•”â•â–¼â•â•— â•”â•â–¼â•â•â•â•â•—
 â•‘Procâ•‘ â•‘Error â•‘
 â•šâ•â•¤â•â• â•šâ•â•¤â•â•â•â•â•â•
   â”‚     â”‚
   â””â”€â”€â”¬â”€â”€â”˜
      â”‚
   â•”â•â•â–¼â•â•â•—
   â•‘ End â•‘
   â•šâ•â•â•â•â•â•
```

In App, renders as:

- Rounded corners on Start/End
- Diamond decision box
- Colored arrows (green=yes, red=no)
- Shadows and spacing for clarity

---

### Marp Presentation Markdown

```markdown
---
marp: true
theme: uncover
paginate: true
---

# uDOS Guide

---

## Getting Started

1. Boot TinyCore
2. Run `./start_udos.sh`
3. Type your first command

---

## Two Realms

- Device Mesh (Offline)
- Wizard Server (Optional)
```

Rendering:

- **TUI:** Text outline with `---` separators
- **App:** Full slide presentation with CSS styling
- **Export:** HTML5 slideshow or PDF

---

## ğŸ¨ Color Semantics (TUI)

When rendering in terminal with color support:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Color       â”‚ Meaning       â”‚ Teletext Block  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Green       â”‚ Success/OK    â”‚ âœ“ or â—† (filled) â”‚
â”‚ Red         â”‚ Error/Fail    â”‚ âœ— or â–² (filled) â”‚
â”‚ Blue        â”‚ Process       â”‚ â–  (box)         â”‚
â”‚ Yellow      â”‚ Decision      â”‚ â—‡ (diamond)     â”‚
â”‚ Cyan        â”‚ Input/Output  â”‚ â—¯ (circle)      â”‚
â”‚ Magenta     â”‚ Action        â”‚ â˜… (star)        â”‚
â”‚ Default     â”‚ Neutral       â”‚ Normal          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš« What NOT to Do

1. **Don't hardcode box drawing** in command handlers
   - Use consolidated `block_graphics.py` module
2. **Don't render SVGs in TUI**

   - SVGs are for Tauri app only
   - TUI gets ASCII fallback always

3. **Don't bypass Graphics Service**

   - Always use `core.services.graphics_service` in Core
   - Let service handle rendering details

4. **Don't create ASCII without source**

   - All ASCII diagrams must have markdown source
   - Enables regeneration in other formats

5. **Don't assume internet in TUI**
   - Graphics Service must work offline
   - Fallback to cached templates

---

## âœ… What TO Do

1. **Source markdown diagrams** in knowledge base

   - Mermaid, Flowchart.js, or Marp
   - Version-controlled, human-readable

2. **Use Graphics Service** for all rendering

   - Handles format conversion automatically
   - Provides fallbacks

3. **Test ASCII â‰ˆ SVG equivalency**

   - Same diagram should communicate same meaning in both
   - Colors encode same semantics

4. **Cache results locally**

   - Store both ASCII and SVG in data directory
   - Enables offline viewing

5. **Document diagram types** in knowledge base
   - Include frontmatter describing diagram
   - Link to source format

---

## ğŸ“– Related Specifications

- [FORMAT-ARCHITECTURE.md](../../app-beta/docs/FORMAT-ARCHITECTURE.md) - App markdown formats
- [TELETEXT-MAPPING.md](../specs/teletext-mapping.md) - **TO BE CREATED** - Block character mapping
- [PORT-REGISTRY.md](../../extensions/PORT-REGISTRY.md) - Port assignments
- [AGENTS.md](../../AGENTS.md) - Development rules

---

## ğŸ¯ Success Criteria

âœ… **Graphics Tier 1 (Markdown Source):**

- Diagrams stored as markdown in knowledge base
- Flowchart.js, Mermaid, and Marp formats supported
- All diagrams version-controlled

âœ… **Graphics Tier 2 (ASCII-Teletext):**

- Every markdown diagram has ASCII equivalent
- ASCII version renders in TUI without service
- Colors map to semantic meaning
- No wrapping/clipping on standard terminals (80-120 chars)

âœ… **Graphics Tier 3 (SVG):**

- Graphics Service produces SVG from markdown
- Tauri app renders SVG with theme styling
- Same diagram looks consistent in both paths
- Performance: <500ms render time

âœ… **API/Service:**

- Graphics Service running on port 5555
- All 5 formats functional
- Offline fallback working
- Proper error handling

---

**Owner:** uDOS Core/App/API Teams  
**Last Updated:** 2026-01-14  
**Version:** Alpha v1.0.2.0
