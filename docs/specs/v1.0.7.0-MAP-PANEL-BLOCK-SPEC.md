# v1.0.7.0 â€” Map & Panel Block Specification

**Version:** 1.0.0  
**Status:** Locked for Implementation  
**Last Updated:** 2026-01-18

---

## Overview

The `map` and `panel` blocks enable spatial rendering in uDOS markdown documents. Both blocks produce **2D character grids** but serve different purposes:

- **`map`** â€” Render sparse world tiles with sprite overlays, terrain, POIs, centered on player position
- **`panel`** â€” Render static ASCII/teletext graphics, HUD elements, status displays, graphs

---

## 1. MAP Block

### Purpose

Render a viewport into a sparse world, showing terrain, objects, sprites, and markers at a specific layer with automatic centering and scrolling.

### Syntax

````markdown
```map
center: $player.pos.tile
layer: $world.layer
viewport: "80x30"
style: "teletext"
show:
  terrain: true
  objects: true
  sprites: true
  markers: true
  fog_of_war: false
sprites: $sprites
```
````

### Parameters

| Parameter  | Type   | Default      | Purpose                                                            |
| ---------- | ------ | ------------ | ------------------------------------------------------------------ |
| `center`   | string | Required     | Player/camera position (e.g., `AA10`, `$player.tile`, `L300-AA10`) |
| `layer`    | number | Required     | Layer to render (e.g., `300`)                                      |
| `viewport` | string | `"80x30"`    | Dimensions: `"80x30"` or `"40x15"` (mini)                          |
| `style`    | string | `"teletext"` | Rendering: `"teletext"`, `"quadrant"`, `"shade"`, `"ascii"`        |
| `show`     | object | all true     | What to render (terrain, objects, sprites, markers, fog_of_war)    |
| `sprites`  | array  | `[]`         | Array of sprite objects: `[{id, ch, z, pos}, ...]`                 |
| `terrain`  | object | optional     | Custom terrain layer (for override)                                |

### Rendering Rules

**Viewport Calculation:**

1. Get `center` position (expand variables if needed)
2. Calculate visible tile range based on `viewport` size
3. Standard: 80Ã—30 â†’ center player 40Ã—15
4. Mini: 40Ã—15 â†’ center player 20Ã—7

**Layer Stacking (Z-order):**

```
Layer 3 (Background):   terrain, fog
Layer 2 (Objects):      static objects, POIs, markers
Layer 1 (Sprites):      dynamic characters (z-value controls)
Layer 0 (Foreground):   effects, highlights
```

**Sprite Rendering:**

- Sprites have `z` (depth) â€” higher z renders on top
- Position: `{tile: "AA10", layer: 300}` or `{x: 5, y: 10}` (grid-relative, 0-indexed)
- Character: `ch` (single character, `@` for player, `:` for NPC, `=` for door)
- Color/style applied per character (from `$sprite.style` or global palette)

**Terrain Lookup:**

- Fetch terrain type from `uDOS-table.db` (if available) or fallback to flat color
- ASCII char from `terrain_types[type].ascii_char`
- Teletext block from `terrain_types[type].teletext_block`

**Fog of War (optional):**

- If enabled, shade unexplored tiles (â–‘ or lighter color)
- Visible radius: ~6 tiles from player (can be parametrized)

### Example: Simple Map

````markdown
```map
center: $player.pos.tile
layer: 300
viewport: "80x30"
style: "teletext"
show:
  terrain: true
  sprites: true
sprites: [
  { id: "player", ch: "@", z: 10, pos: { tile: "AA10", layer: 300 } },
  { id: "npc_merchant", ch: "M", z: 5, pos: { tile: "AB10", layer: 300 } }
]
```
````

### Example: Mini Viewport with HUD

````markdown
```map
center: $player.pos.tile
layer: $world.layer
viewport: "40x15"
style: "ascii"
show:
  terrain: true
  sprites: true
  fog_of_war: true
sprites: $sprites
```
````

---

## 2. PANEL Block

### Purpose

Render static ASCII/teletext graphics, UI panels, status bars, graphs, and decorative elements. No sprite dynamics or world interactionâ€”purely presentational.

### Syntax

````markdown
```panel
style: "teletext"
width: 78
height: 12
content:
  - type: border
    style: "heavy"
  - type: text
    align: "center"
    color: "cyan"
    text: "MAIN MENU"
  - type: hbar
    value: 0.75
    label: "Health"
    width: 60
  - type: grid
    rows: 3
    cols: 3
    data: [[...], [...], ...]
```
````

### Supported Content Types

#### 1. Border

```yaml
- type: border
  style: "heavy" # or "light", "double", "rounded"
  fill: false # if true, fill interior with bg color
```

**Renders:** Box-drawing characters

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

#### 2. Text

```yaml
- type: text
  text: "Hello, $name"
  align: "left" # or "center", "right"
  color: "cyan" # optional: ANSI color
  bold: false
  width: 78 # wrap/pad to width
```

**Behavior:**

- Interpolate `$variables`
- Wrap at `width`
- Pad to align

#### 3. Horizontal Bar

```yaml
- type: hbar
  label: "HP"
  value: 0.75 # 0.0-1.0
  width: 40
  filled_char: "â–ˆ"
  empty_char: "â–‘"
  show_percent: true
```

**Renders:**

```
HP: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 75%
```

#### 4. Vertical Bar

```yaml
- type: vbar
  label: "Coins"
  value: 50
  max: 100
  height: 8
```

**Renders:**

```
Coins
  â–ˆ
  â–ˆ
  â–ˆ
  â–ˆ
  â–‘
  â–‘
  â–‘
  â–‘
 50/100
```

#### 5. Grid/Table

```yaml
- type: grid
  rows: 3
  cols: 4
  data:
    [
      ["Name", "HP", "Exp", "Level"],
      ["$player.name", "10/10", "500", "5"],
      ["Companion", "5/8", "250", "3"],
    ]
  borders: true
  header_row: 0
```

**Renders:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name       â”‚ HP    â”‚ Exp  â”‚ Level  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Traveller  â”‚ 10/10 â”‚ 500  â”‚ 5      â”‚
â”‚ Companion  â”‚ 5/8   â”‚ 250  â”‚ 3      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 6. Sextant Block (Embedded Graphics)

```yaml
- type: sextant
  data: |
    ğŸ¬€ğŸ¬ğŸ¬‚ğŸ¬ƒğŸ¬„
    ğŸ¬…ğŸ¬†ğŸ¬‡ğŸ¬ˆğŸ¬‰
    ğŸ¬ŠğŸ¬‹ğŸ¬ŒğŸ¬ğŸ¬
```

**Renders:** Raw sextant/Unicode block characters (no processing)

#### 7. ASCII Art

```yaml
- type: ascii
  data: |
    _____
   /     \
  | (o_o) |
   \_____/
```

#### 8. Spacer

```yaml
- type: spacer
  height: 2
```

### Panel Examples

#### Example 1: Character Status Screen

````markdown
```panel
style: "teletext"
width: 78
content:
  - type: border
    style: "double"
  - type: text
    align: "center"
    text: "âš”ï¸  CHARACTER STATUS"
  - type: spacer
    height: 1
  - type: grid
    data: [
      ["Stat", "Value"],
      ["Name", "$player.name"],
      ["HP", "$player.hp"],
      ["Coins", "$player.coins"],
      ["Level", "$player.level"]
    ]
    borders: true
  - type: spacer
    height: 1
  - type: border
    style: "double"
```
````

#### Example 2: Progress Bar

````markdown
```panel
style: "ascii"
width: 50
content:
  - type: text
    text: "Loading..."
  - type: hbar
    label: "Progress"
    value: $progress
    width: 40
    show_percent: true
```
````

#### Example 3: Decorative Frame

````markdown
```panel
style: "teletext"
width: 40
content:
  - type: border
    style: "heavy"
  - type: text
    align: "center"
    text: "âœ¨ Welcome âœ¨"
  - type: spacer
    height: 1
  - type: text
    align: "center"
    text: "Press ENTER to begin"
  - type: border
    style: "heavy"
```
````

---

## 3. Rendering Pipeline

### Input â†’ Output

```
Map/Panel Block (YAML)
    â†“
Parse parameters + content
    â†“
Fetch data (sprites, terrain, variables)
    â†“
Render to 2D grid (80Ã—30 or custom)
    â†“
Apply style (teletext â†’ sextant â†’ fallback)
    â†“
Convert to string (with ANSI colors if terminal)
    â†“
Display in viewport
```

### Style System

**Teletext (Primary):**

- Uses sextant Unicode + color ANSI codes
- Fallback to quadrant if needed

**Quadrant (Alternative):**

- â–€ â–„ â–ˆ â–Œ â– (half blocks + quadrants)
- Cleaner on narrower terminals

**Shade (Fallback):**

- â–‘ â–’ â–“ â–ˆ (density-based blocks)
- Works on older terminals

**ASCII (Last Resort):**

- . : # @ % (text characters only)
- Guaranteed portable

---

## 4. Variable Interpolation

All text fields support `$variable` interpolation:

````markdown
```panel
content:
  - type: text
    text: "Welcome, $player.name! You have $player.coins coins."
```
````

Supported access patterns:

- `$var` â€” simple variable
- `$obj.field` â€” object property
- `$arr[0]` â€” array index
- `$obj.nested.deep` â€” deep nesting

---

## 5. Viewport Management

### Standard Viewport (80Ã—30)

- Full terminal width
- Typical console height
- Default for story-mode experiences

### Mini Viewport (40Ã—15)

- Half width (right side can have status panel)
- Half height
- For split-screen layouts

### Custom Viewport

```yaml
viewport: "100x40" # Custom widthÃ—height
```

---

## 6. Color System

### ANSI Colors

| Name    | Code | Usage               |
| ------- | ---- | ------------------- |
| black   | 30   | Shadows, dark areas |
| red     | 31   | Danger, fire        |
| green   | 32   | Safe, health        |
| yellow  | 33   | Warning, coins      |
| blue    | 34   | Water, sky          |
| magenta | 35   | Magic, special      |
| cyan    | 36   | Info, UI            |
| white   | 37   | Default, text       |

### Block Characters with Color

```yaml
- type: text
  text: "Health is critical!"
  color: "red"
```

---

## 7. Implementation Checklist

- [ ] Parser: Parse `map` block YAML
- [ ] Parser: Parse `panel` block YAML
- [ ] Renderer: 2D grid buffer (char array)
- [ ] Renderer: Viewport calculation + centering
- [ ] Renderer: Sprite z-sorting and placement
- [ ] Renderer: Terrain lookup
- [ ] Renderer: Border drawing (box-drawing chars)
- [ ] Renderer: Bar rendering (hbar, vbar)
- [ ] Renderer: Grid/table rendering
- [ ] Renderer: Sextant/teletext fallback
- [ ] Interpolator: Variable expansion in text
- [ ] Output: 2D grid â†’ string (with ANSI codes)
- [ ] Testing: Example maps with sprites
- [ ] Testing: Example panels (status, menu)

---

## 8. Performance Targets

| Operation              | Target          | Notes               |
| ---------------------- | --------------- | ------------------- |
| Render 80Ã—30 map       | < 100ms         | With terrain lookup |
| Render panel           | < 50ms          | Text-only overhead  |
| Sprite update          | < 10ms          | Z-sort + redraw     |
| Variable interpolation | < 5ms per panel | Text substitution   |

---

## References

- [Spatial Brief](./u_dos_spatial_text_graphics_brief.md) â€” Grid geometry
- [TypeScript Runtime](./typescript.md) â€” Block execution
- [ANSI Art](../howto/ANSI-ART.md) â€” Terminal graphics primer
