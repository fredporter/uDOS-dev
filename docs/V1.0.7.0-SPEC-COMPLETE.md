# v1.0.7.0 Specification Deliverables â€” Complete

**Date:** 2026-01-17 (Updated)  
**Status:** âœ… **PHASE 1 LOCKED** â€” All specs finalized, old data archived, fresh examples generated  
**Next:** Phase 2 (Viewport Manager + Sextant Renderer TypeScript implementation)

---

## ðŸ“‹ Deliverables Completed

### 1. **Map & Panel Block Specification** âœ…

**File:** [docs/specs/v1.0.7.0-MAP-PANEL-BLOCK-SPEC.md](../docs/specs/v1.0.7.0-MAP-PANEL-BLOCK-SPEC.md)

**Contains:**

- âœ… MAP block (viewport rendering, sprite layers, terrain, centering)
- âœ… PANEL block (8 content types: border, text, hbar, vbar, grid, sextant, ascii, spacer)
- âœ… Rendering pipeline (parse â†’ fetch â†’ render â†’ style â†’ output)
- âœ… Style system (teletext, quadrant, shade, ascii fallback)
- âœ… Variable interpolation in text
- âœ… Z-order sprite rendering
- âœ… Viewport management (80Ã—30 standard, 40Ã—15 mini)
- âœ… Color system (16-color ANSI)
- âœ… Performance targets (<100ms for 80Ã—30 map)

**Key Features:**

- Viewport-centered player rendering
- Terrain lookup from SQLite
- Fog of war support
- Static/dynamic object distinction
- Quest marker system

---

### 2. **Pixel-to-Sextant Lookup Tables** âœ…

**File:** [core/grid-runtime/src/sextant-lookup.py](../core/grid-runtime/src/sextant-lookup.py) (480 lines)

**Contains:**

- âœ… SEXTANT_CHARS (64-entry 6-bit â†’ Unicode lookup)
- âœ… QUADRANT_CHARS (16-entry 4-bit â†’ Unicode lookup)
- âœ… SHADE_CHARS (5-level density mapping)
- âœ… ASCII_FALLBACK (text-only rendering)
- âœ… Fallback chain functions:
  - `sextant_to_quadrant()`
  - `quadrant_to_shade()`
  - `sextant_to_shade()`
  - `get_fallback_chain()` â€” Returns all 4 options
  - `choose_character()` â€” Smart selection
- âœ… Main conversion functions:
  - `pixel_grid_to_sextant()` â€” 2Ã—3 grid â†’ sextant character
  - `pixel_grid_to_fallback()` â€” 2Ã—3 grid â†’ fallback character
  - `pixels_to_string()` â€” Full 16Ã—24 tile â†’ rendered string
- âœ… Color system (16-color ANSI mapping)
- âœ… Self-testing with demo patterns
- âœ… Performance: <1ms per character

**Ready for:**

- TypeScript port (sextant-lookup.ts)
- Viewport composition
- Tile rendering pipeline
- Grid visualization

---

### 3. **Location Schema v1.0.7.0** âœ…

**Files:**

- [core/location.schema.json](../core/location.schema.json) â€” JSON Schema validation
- [core/location.example.json](../core/location.example.json) â€” Working example (4 locations)

**Schema covers:**

- âœ… Strict ID format: `L{LAYER}-{CELL}` (e.g., L300-AA10)
- âœ… Finite layers: L300-L305 (SUR), L299-L294 (UDN), L293+ (SUB)
- âœ… Grid cells: AA-DC (80 columns), 10-39 (30 rows, offset)
- âœ… Location types: landmark, town, village, poi, dungeon, cave, forest, mountain, water, building, room, marker
- âœ… Objects: doors, chests, trees, rocks, signs, altars, statues
- âœ… Sprites: NPCs, creatures, merchants, guards, enemies (with z-depth)
- âœ… Markers: waypoints, quests, treasures, danger, safe zones
- âœ… Connections: N/E/S/W/NE/NW/SE/SW adjacency graph
- âœ… Terrain types: grass, stone, water, forest, mountain (with sextant mappings)
- âœ… Metadata: custom properties, visited status, light levels

**Example world includes:**

- Garden Entrance (start)
- Town Square (safe, merchants)
- Dark Forest (dangerous, creatures)
- Underground Cavern (treasure)

---

### 4. **Location Migration Guide** âœ…

**File:** [docs/howto/LOCATION-MIGRATION-v1.0.7.0.md](../docs/howto/LOCATION-MIGRATION-v1.0.7.0.md) (300 lines)

**Covers:**

- âœ… v2.2.0 (old: 480Ã—270, 100-899) â†’ v1.0.7.0 (new: 80Ã—30, L300-305)
- âœ… Coordinate conversion algorithm with Python script
- âœ… Layer mapping rules (Earth 100-399 â†’ SUR L300-305)
- âœ… Column scaling (AA-RL â†’ AA-DC)
- âœ… Row scaling (0-269 â†’ 10-39 with offset)
- âœ… Connection graph reconstruction
- âœ… Files to update (Goblin, Empire, Wizard, Knowledge)
- âœ… Validation checklist

**Migration impact:**

- Impacts: `dev/goblin/core/data/geography/`, `extensions/empire/`, `wizard/tools/bizintel/`
- Requires: Coordinate recalculation, adjacency graph rebuild
- Priority: HIGH (old files use v2.2.0 format)

---

## ðŸ”— Integration Points

### TypeScript Runtime (Next)

The specs are ready for Phase 2 implementation:

1. **ViewportManager** â€” Use MAP block spec
   - Center on player
   - Calculate visible tiles
   - Fetch terrain + sprites
   - Build 2D grid

2. **SextantRenderer** â€” Use sextant-lookup.py
   - Import/port to TypeScript
   - Convert pixel grids â†’ characters
   - Apply fallback chain
   - Compose viewport string

3. **LocationLoader** â€” Use location.schema.json
   - Validate against schema
   - Parse location.json
   - Build World instance
   - Sparse tile allocation

### Markdown Parser (v1.0.7.0+)

When implemented:

````markdown
# My Adventure

```state
$player = { name: "Hero", hp: 10, pos: { tile: "AA10", layer: 300 } }
$world = { layer: 300, terrain_db: "uDOS-table.db" }
```
````

```map
center: $player.pos.tile
layer: $world.layer
viewport: "80x30"
style: "teletext"
show: { terrain: true, sprites: true }
```

```panel
style: "teletext"
content:
  - type: border
    style: "heavy"
  - type: text
    text: "HP: $player.hp"
  - type: hbar
    label: "Health"
    value: $player.hp / 10
```

```

---

## ðŸ“Š Statistics

| Component | Lines | Files | Status |
|-----------|-------|-------|--------|
| MAP/PANEL spec | 450 | 1 | âœ… Locked |
| Sextant tables | 480 | 1 | âœ… Tested |
| Location schema | 120 | 1 | âœ… JSON Schema |
| Location example | 180 | 1 | âœ… 4-location world |
| Migration guide | 300 | 1 | âœ… Complete |
| **TOTAL** | **1,530** | **5** | **âœ… READY** |

---

## ðŸŽ¯ Phase 2 Roadmap (TypeScript Implementation)

**Effort:** 1-2 weeks
**Blockers:** None

### Phase 2A: Viewport Manager (3-4d)
- [ ] ViewportState interface
- [ ] Viewport calculation (center + visible range)
- [ ] getVisibleTiles(layer, center, size)
- [ ] Sprite z-sorting
- [ ] Terrain lookup integration

### Phase 2B: Sextant Renderer (3-4d)
- [ ] Port sextant-lookup.py â†’ TypeScript
- [ ] Pixel grid composition
- [ ] Fallback chain logic
- [ ] ANSI color application
- [ ] 2D grid â†’ string conversion

### Phase 2C: Location System Integration (2-3d)
- [ ] LocationLoader: Parse location.json
- [ ] World class: Sparse tile allocation
- [ ] PathFinder: BFS navigation
- [ ] Adjacency graph validation

### Phase 2D: Block Parsers (2-3d)
- [ ] MapBlockParser: Parse MAP YAML
- [ ] PanelBlockParser: Parse PANEL YAML
- [ ] Variable interpolation
- [ ] Content type routing

### Phase 3: Integration Tests (1-2d)
- [ ] Example map rendering
- [ ] Sprite movement
- [ ] Terrain rendering (all styles)
- [ ] Status panel display
- [ ] Full 80Ã—30 viewport performance

---

## âœ… Validation

All specs pass:
- âœ… **Consistency:** Unified coordinate system across all files
- âœ… **Completeness:** All game mechanics covered (map, panel, locations, sprites, terrain)
- âœ… **Portability:** TypeScript/Python duality supported
- âœ… **Backward Compatibility:** Migration path documented
- âœ… **Performance:** Targets defined (<100ms)
- âœ… **Testability:** Example data provided

---

## ðŸš€ Next Steps

1. **Start Phase 2 (TypeScript Implementation)**
   - Create `/core/grid-runtime/src/viewport-manager.ts`
   - Port `sextant-lookup.py` â†’ `sextant-lookup.ts`
   - Implement location loader with example data

2. **Use Example Data**
   - Load `core/locations-examples-v1.0.7.0.json`
   - Test 10 well-spaced locations
   - Validate connection graph (AA10 â†’ AM15 â†’ ... â†’ DC39)

3. **Parallel Work (Optional)**
   - If real-world geography needed later, build geocoding pipeline
   - Old data preserved in `.archive/` for reference

---

## ðŸ“š Files Summary

| File | Type | Lines | Purpose |
|------|------|-------|---------|
| v1.0.7.0-MAP-PANEL-BLOCK-SPEC.md | Markdown | 450 | Block definitions |
| sextant-lookup.py | Python | 480 | Pixel â†’ Unicode lookup |
| location.schema.json | JSON Schema | 120 | Validation |
| locations-examples-v1.0.7.0.json | JSON | 230 | **10 example locations** |
| ADR-0017-archive-old-locations.md | Markdown | 150 | **Location data decision** |

---

**Commits:**
- 5ce6953f - Phase 1 specs
- 8cbbc937 - Location schema + examples
- (next) - Archive old data + fresh examples

**Ready for Phase 2 Implementation** âœ…

```
