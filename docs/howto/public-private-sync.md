# Public / Private Repo Sync Plan

**Last Updated:** 2026-01-14  
**Audience:** Maintainers

---

## Repos

- Private: fredporter/uDOS-dev (source of truth, dev-only content)
- Public: fredporter/uDOS-core (release docs + assets mirror)

---

## What goes where

- Private (keep): dev branches, CI configs, internal tooling, wizard config files with provider keys, build scripts, working notes, tests, top-level `/docs` (engineering docs).
- Public (publish):
  - Source code: `core/` (includes `core/docs/`), `extensions/api/`, `knowledge/`, `data/`
  - Distribution: `distribution/` (installer, TCZ packaging, stacks)
  - Tools: `library/alpine/` (ISO downloader/manager)
  - Root: Auto-generated `README.md` with links, `LICENSE.txt`

**Exclusions from public sync:**

- Test files (`tests/`, `*_test.py`)
- Python bytecode (`__pycache__`, `*.pyc`)
- Dev/archive folders (`.dev/`, `.archive/`)
- Wizard server (`wizard/` - contains AI routing, secrets)
- Extensions (`extensions/` - API, Transport, and other public features)
- Apps (`app/`, `app-beta/` - separate repos)

Generated artifacts are never tracked in git; only uploaded to Releases:

- `distribution/tcz/*.tcz*` (TCZ + .dep/.md5.txt/.info/.list)
- `distribution/uDOS-*.iso`

---

## Release flow

1. Tag in private repo: `vX.Y.Z` (ensure tests pass).
2. Private CI builds TCZ/ISO, generates checksums, creates GitHub Release, uploads assets.
3. Sync job mirrors docs + version metadata to public repo (`main`) and creates a matching Release (assets copied from private release).

---

## Required secrets (private repo)

- `PUBLIC_REPO`: `fredporter/uDOS-core`
- `PUBLIC_TOKEN`: PAT with `repo` scope to push to public repo
- `GH_TOKEN`: default `GITHUB_TOKEN` is fine for private release

---

## CI overview

- `.github/workflows/release.yml`
  - Trigger: tag push `v*`
  - Install `squashfs-tools`, run Python builder (core/api/wizard)
  - Upload built `distribution/tcz` artifacts + checksums to Release
- `.github/workflows/sync-public.yml`
  - Trigger: `release` published
  - Push selected docs + `version.json` to public repo `main`
  - Recreate Release in public and upload same assets

---

## Automation details

- Mirror scope:
  - `README.md` (auto-generated with links to core/docs/)
  - Source: `core/` (includes core/docs/), `extensions/api/`, `knowledge/`, `data/`
- Exclusions:
  - Do not mirror `.github/` or dev-only files to avoid workflow loops.
- Release tag:
  - Uses the private release tag name verbatim (e.g., `v1.0.2.0`).
- Assets source:
  - Assets are fetched from the private Release and uploaded to the public Release.
- Safety:
  - Public push uses `PUBLIC_TOKEN` limited to the public repo.
  - Private access uses default `GITHUB_TOKEN` to read assets.

---

## Test run (pre-release)

1. Commit and push all changes to `main` (private).
2. Create a pre-release tag (e.g., `v1.0.2.0-rc1`) and publish a Release in private.
3. Verify:
   - Private Release contains `*.tcz` and `*.md5.txt` assets.
   - Public repo `main` has updated `docs/` and version files.
   - Public Release exists for the same tag and includes the assets.

---

## Manual fallback

If CI sync fails:

```sh
# Clone public
rm -rf /tmp/uDOS-core
git clone https://github.com/fredporter/uDOS-core.git /tmp/uDOS-core

# Copy source code
rsync -av --delete --exclude='__pycache__' --exclude='*.pyc' --exclude='tests/' --exclude='.dev' --exclude='.archive' core/ /tmp/uDOS-core/core/
rsync -av --delete --exclude='__pycache__' --exclude='*.pyc' --exclude='tests/' --exclude='.dev' --exclude='.archive' extensions/api/ /tmp/uDOS-core/extensions/api/

# Copy distribution and library assets
rsync -av --delete --exclude='*.iso' --exclude='builds/' --exclude='test/' distribution/ /tmp/uDOS-core/distribution/
rsync -av --delete --exclude='__pycache__' --exclude='*.pyc' library/ /tmp/uDOS-core/library/

# Copy data and knowledge (core/ already includes core/docs/)
rsync -av --delete data/ /tmp/uDOS-core/data/
rsync -av --delete knowledge/ /tmp/uDOS-core/knowledge/

# Generate README (or copy pre-generated one)
rsync -av LICENSE.txt /tmp/uDOS-core/
# NOTE: README.md is auto-generated by CI workflow

# Commit + push
cd /tmp/uDOS-core
git checkout -B main
git add -A
git commit -m "Sync vX.Y.Z: core, extensions/api, distribution, library, data, knowledge"
git push origin main
```

---

## Next steps

- Create `fredporter/uDOS-core` (empty on `main`)
- Add repo secrets in private: `PUBLIC_REPO`, `PUBLIC_TOKEN`
- Dry-run CI on a pre-release tag (e.g., `v1.0.2-rc1`)
