# Phase 5E: Command Handlers - Quick Reference

**Previous Phase:** Phase 5D (Infrastructure) âœ… COMPLETE  
**Current Phase:** Phase 5E (Command Handlers) - PLANNING  
**Next Phase:** Phase 5F (TUI Integration) - PLANNED

---

## Objective

Implement three command handlers to enable location system interaction in the TUI:

1. **MAP** - Display location grid
2. **PANEL** - Show location info
3. **GOTO** - Navigate between locations

---

## Handler Specification

### 1. MAP Handler (`core/commands/map_handler.py`)

**Command:** `MAP [location_id]`

**Purpose:** Display tile grid for current or specified location

**Implementation:**

```python
from core.commands.base import BaseCommandHandler
from core.locations import load_locations

class MapHandler(BaseCommandHandler):
    """Display location tile grid."""

    def handle(self, command: str, params: List[str], grid, parser):
        """
        Handle MAP command.

        Args:
            command: "MAP"
            params: [location_id] or empty for current location
            grid: TUI grid for rendering
            parser: Command parser
        """
        # Get location ID (from params or player state)
        location_id = params[0] if params else self.get_current_location()

        # Load location
        db = load_locations()
        location = db.get(location_id)

        if not location:
            return {"status": "error", "message": f"Location {location_id} not found"}

        # Render grid
        grid_display = self._render_grid(location)

        return {
            "status": "success",
            "location": location.name,
            "grid": grid_display,
            "width": 80,
            "height": 24
        }

    def _render_grid(self, location):
        """Render location tile grid with sextant/ASCII fallback."""
        # Will implement using TUI grid system
        # Each tile cell (16Ã—24 pixels) renders as sextant block
        # Objects/sprites displayed with characters
        # Fallback to ASCII blocks
        pass
```

**Features:**

- Display location name and tile grid
- Show objects, sprites, markers
- Support multi-cell rendering
- Color support for objects/sprites
- ASCII fallback for limited terminals

**Output Example:**

```
â”Œâ”€ Tokyo - Shibuya Crossing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer: L300 (Terrestrial)  Timezone: UTC+9                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AA  AB  AC  AD  AE  AF                                             â”‚
â”‚ â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„   Tile Grid (6Ã—4 cells)                   â”‚
â”‚ â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€   10  ğŸ¢  ğŸš—  ğŸ´  ğŸŒ†  ğŸ“  13  (examples)â”‚
â”‚                                                                     â”‚
â”‚ BA  BB  BC  BD  BE  BF                                             â”‚
â”‚ â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„   Legend:                                 â”‚
â”‚ â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€   ğŸ¢ = Structure                          â”‚
â”‚                           ğŸš— = Vehicle                             â”‚
â”‚ CA  CB  CC  CD  CE  CF   ğŸ´ = Marker                              â”‚
â”‚ â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„  â–€â–„   ğŸŒ† = Scenic                             â”‚
â”‚ â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€  â–„â–€   ğŸ“ = Waypoint                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation Checklist:**

- [ ] Create map_handler.py
- [ ] Implement \_render_grid() for sextant/ASCII
- [ ] Add object/sprite rendering
- [ ] Add color support
- [ ] Add grid scrolling for large locations
- [ ] Integration test (render grid, validate output)

---

### 2. PANEL Handler (`core/commands/panel_handler.py`)

**Command:** `PANEL [location_id]`

**Purpose:** Display detailed location information

**Implementation:**

```python
class PanelHandler(BaseCommandHandler):
    """Display location information panel."""

    def handle(self, command: str, params: List[str], grid, parser):
        """
        Handle PANEL command.

        Args:
            command: "PANEL"
            params: [location_id] or empty for current location
        """
        location_id = params[0] if params else self.get_current_location()

        db = load_locations()
        location = db.get(location_id)

        if not location:
            return {"status": "error", "message": f"Location {location_id} not found"}

        # Get local time
        service = LocationService()
        local_time = service.get_local_time(location_id)

        # Build panel
        panel = self._build_panel(location, local_time)

        return {
            "status": "success",
            "panel": panel,
            "height": 20
        }

    def _build_panel(self, location, local_time):
        """Build location information panel."""
        # Will render as box with formatted information
        pass
```

**Output Example:**

```
â”Œâ”€ Location Information â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  ğŸ“ Tokyo - Shibuya Crossing                               â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚                                                             â”‚
â”‚  Region:     Asia East (asia_east)                         â”‚
â”‚  Type:       Major City (metropolis)                       â”‚
â”‚  Layer:      L300 (Terrestrial)                            â”‚
â”‚  Scale:      Terrestrial                                   â”‚
â”‚  Continent:  Asia                                          â”‚
â”‚                                                             â”‚
â”‚  ğŸ“Œ Coordinates: 35.6595Â°N, 139.7004Â°E                    â”‚
â”‚  ğŸŒ Timezone: UTC+9                                        â”‚
â”‚  ğŸ• Current Time: 2026-01-18 15:45:32                     â”‚
â”‚                                                             â”‚
â”‚  Description:                                              â”‚
â”‚  The world's busiest pedestrian crossing. Neon lights      â”‚
â”‚  reflect off glass facades in the perpetual neon night.    â”‚
â”‚                                                             â”‚
â”‚  ğŸšª Exits (Connected Locations):                           â”‚
â”‚     â†‘ North â†’ Shinjuku (L300-BK10)                        â”‚
â”‚     â† West  â†’ Omotesando (L300-AI10)                      â”‚
â”‚                                                             â”‚
â”‚  ğŸ“¦ Markers: 2 waypoints, 1 poi                            â”‚
â”‚  ğŸ‘¥ NPCs: 3 available                                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation Checklist:**

- [ ] Create panel_handler.py
- [ ] Format location metadata
- [ ] Get local time from LocationService
- [ ] List connections with directions
- [ ] Display tile markers count
- [ ] Add NPC stubs (for future expansion)
- [ ] Integration test (panel display, validate format)

---

### 3. GOTO Handler (`core/commands/goto_handler.py`)

**Command:** `GOTO <location_id>` or `GOTO <direction>`

**Purpose:** Navigate between locations

**Implementation:**

```python
class GotoHandler(BaseCommandHandler):
    """Navigate to another location."""

    def handle(self, command: str, params: List[str], grid, parser):
        """
        Handle GOTO command.

        Args:
            command: "GOTO"
            params: ["location_id"] or ["direction"]
        """
        if not params:
            return {"status": "error", "message": "GOTO requires location ID or direction"}

        current_location = self.get_current_location()
        db = load_locations()
        location = db.get(current_location)

        # Check if params[0] is direction
        direction = params[0].lower()
        if direction in ['north', 'south', 'east', 'west', 'up', 'down']:
            # Find connection in that direction
            target_id = self._find_connection_by_direction(location, direction)
        else:
            # Treat as location ID
            target_id = params[0]

        if not target_id:
            return {"status": "error", "message": f"Cannot go {direction} from here"}

        # Validate target exists
        target = db.get(target_id)
        if not target:
            return {"status": "error", "message": f"Target location {target_id} not found"}

        # Update player state
        self.set_current_location(target_id)

        return {
            "status": "success",
            "message": f"Traveled to {target.name}",
            "location_id": target_id,
            "location_name": target.name
        }

    def _find_connection_by_direction(self, location, direction):
        """Find connection matching direction."""
        for conn in location.connections:
            if conn.direction.lower() == direction:
                return conn.to
        return None
```

**Features:**

- Navigate to adjacent locations
- Support direction shortcuts (north, south, east, west)
- Validate pathfinding
- Update game state
- Support quest/item requirements (for future)

**Usage Examples:**

```
> GOTO L300-BK10
âœ“ Traveled to Shinjuku

> GOTO north
âœ“ Traveled to Shinjuku

> GOTO L300-AA10
âœ— Cannot reach Shinjuku from Shibuya
  (Would require pathfinding across multiple locations)
```

**Implementation Checklist:**

- [ ] Create goto_handler.py
- [ ] Implement \_find_connection_by_direction()
- [ ] Validate target exists
- [ ] Update player state (current_location)
- [ ] Support direction shortcuts
- [ ] Add requirement validation (future)
- [ ] Integration test (goto command, verify movement)

---

## Implementation Order

1. **Start:** `map_handler.py` (simpler, grid-based)
2. **Then:** `panel_handler.py` (data formatting)
3. **Finally:** `goto_handler.py` (state management)

---

## Integration with Existing Systems

### LocationService

```python
from core.location_service import LocationService

service = LocationService()
local_time = service.get_local_time("L300-BJ10")
connections = service.get_connections("L300-BJ10")
path = service.find_path("L300-AA10", "L300-BJ10")
```

### LocationDatabase

```python
from core.locations import load_locations

db = load_locations()
location = db.get("L300-BJ10")
asia_locations = db.find_by_region("asia_east")
```

### TUI Grid System

```python
# Render to TUI grid
grid.clear()
grid.add_box(x, y, width, height, border_char, title)
grid.set_char(x, y, char, fg_color, bg_color)
grid.render()
```

### Player State

```python
# Game state management (to be implemented)
player.current_location = "L300-BJ10"
player.visited_locations.add("L300-BJ10")
player.save_state()
```

---

## Testing Strategy

### Unit Tests

```python
# test_map_handler.py
def test_map_render_grid():
    """Test grid rendering for location."""

def test_map_with_objects():
    """Test rendering with objects/sprites."""

def test_map_color_support():
    """Test color rendering."""

# test_panel_handler.py
def test_panel_location_info():
    """Test location information display."""

def test_panel_timezone_display():
    """Test timezone in panel."""

def test_panel_connections():
    """Test connection listing."""

# test_goto_handler.py
def test_goto_adjacent_location():
    """Test navigating to adjacent location."""

def test_goto_by_direction():
    """Test direction shortcuts."""

def test_goto_invalid_target():
    """Test error handling for invalid target."""
```

### Integration Tests

```python
def test_map_goto_panel_workflow():
    """Test complete workflow: MAP -> PANEL -> GOTO."""
```

---

## Files to Create

| File                             | Lines | Purpose                      |
| -------------------------------- | ----- | ---------------------------- |
| `core/commands/map_handler.py`   | 150   | MAP command implementation   |
| `core/commands/panel_handler.py` | 120   | PANEL command implementation |
| `core/commands/goto_handler.py`  | 100   | GOTO command implementation  |
| Tests (3 files)                  | 200   | Comprehensive test coverage  |

**Total New Code:** ~570 lines  
**Total Test Code:** ~200 lines

---

## Success Criteria

âœ… All handlers implemented and tested  
âœ… Commands integrate with LocationService  
âœ… TUI grid rendering works  
âœ… Player state updates on navigation  
âœ… Error handling for invalid locations  
âœ… Direction shortcuts functional  
âœ… 30+ integration tests passing

---

## Ready to Begin?

Phase 5E is ready to start whenever you want to continue:

```bash
# Run Phase 5E work
python -c "
from core.locations import load_locations
db = load_locations()
print(f'âœ… Located {db.count()} locations')
print('Ready to implement command handlers')
"
```

---

_Last Updated: 2026-01-18_  
_Phase: 5E Planning_
